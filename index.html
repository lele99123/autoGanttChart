<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习计划甘特图生成器</title>
    <style>
        /* 隐藏可能存在的服务器启动消息 */
        .server-loading-message {
            display: none !important;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        body {
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .tab-button:hover {
            background-color: #356ac3;
        }
        .input-form, .gantt-chart, .plans-list {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        .form-row {
            margin-bottom: 15px;
        }
        .form-row label {
            display: inline-block;
            margin-right: 10px;
            min-width: 80px;
        }
        .form-row input, .form-row select, .form-row textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .task-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .task-table th, .task-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        .task-table th {
            background-color: #f2f2f2;
        }
        .btn {
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .btn-delete {
            background-color: #4285f4;
            padding: 6px 12px;
        }
        .btn:hover {
            background-color: #356ac3;
        }
        .gantt-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .gantt-table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }
        .gantt-table th, .gantt-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .gantt-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .gantt-cell {
            width: 30px;
            height: 30px;
        }
        .gantt-cell.filled {
            background-color: #4285f4;
        }
        /* 甘特图颜色样式 */
        .gantt-cell.yellow {
            background-color: #FFFF00;
        }
        .gantt-cell.green {
            background-color: #4CAF50;
        }
        .gantt-cell.blue {
            background-color: #2196F3;
        }
        .gantt-cell.empty {
            background-color: #FFFFFF;
        }
        .gantt-header {
            background-color: #4285f4;
            color: white;
            font-weight: bold;
        }
        .subject-cell {
            background-color: #4285f4;
            color: white;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
        }
        .subject-header {
            background-color: #4285f4;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        .gantt-table th.date-header {
            min-width: 60px;
            background-color: #4285f4;
            color: white;
        }
        .btn-group {
            margin-top: 20px;
            display: flex;
        }
        .plans-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .plans-table th, .plans-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        .plans-table th {
            background-color: #f2f2f2;
        }
        .plan-name-input {
            margin-bottom: 15px;
        }
        .plan-name-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 300px;
        }
        
        /* 模态框样式 */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 5px;
            width: 80%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
        }
        
        .close-modal {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
    
    <script>
        // 全局变量
        let currentPlanId = null;
        let currentPlan = null;
        let subjects = {};
        let plans = []; // 存储所有计划
        
        // DOM元素
        let plansTab;
        let inputTab;
        let chartTab; 
        let plansList;
        let inputForm;
        let ganttChart;
        let newPlanBtn;
        let refreshPlansBtn; 
        let addTaskBtn;
        let savePlanBtn;
        let exportCsvBtn;
        let backToPlansBtn;
        let dateInput;
        let planNameInput;
        
        // 全局函数定义 - 这些函数需要在全局作用域中定义，以便HTML元素可以直接调用
        // 查看学习计划
        window.viewPlan = function(planId) {
            // 从本地存储获取计划
            const plansData = getFromLocalStorage('plans') || [];
            const plan = plansData.find(p => p.id === planId);
            
            if (plan) {
                currentPlanId = plan.id;
                currentPlan = plan;
                
                // 显示计划名称
                document.getElementById('current-plan-name').textContent = plan.name;
                
                // 切换到甘特图视图
                plansList.style.display = 'none';
                inputForm.style.display = 'none';
                ganttChart.style.display = 'block';
                
                // 渲染甘特图
                renderGanttChart();
            } else {
                alert('找不到指定的学习计划');
            }
        };
        
        // 编辑学习计划
        window.editPlan = function(planId) {
            // 从本地存储获取计划
            const plansData = getFromLocalStorage('plans') || [];
            const plan = plansData.find(p => p.id === planId);
            
            if (plan) {
                currentPlanId = plan.id;
                currentPlan = plan;
                
                // 填充计划名称和日期
                planNameInput.value = plan.name;
                // 确保日期格式正确
                const planDate = new Date(plan.planDate + 'T00:00:00');
                dateInput.value = planDate.toISOString().split('T')[0];
                
                // 清空任务列表
                clearTaskList();
                
                // 填充任务
                if (plan.StudyTasks && plan.StudyTasks.length > 0) {
                    // 设置第一行数据
                    const firstTask = plan.StudyTasks[0];
                    const firstRow = document.querySelector('#task-list tr');
                    
                    firstRow.querySelector('.subject-select').value = firstTask.subject;
                    populateChapters(firstRow.querySelector('.subject-select'), firstTask.subject);
                    
                    setTimeout(() => {
                        firstRow.querySelector('.chapter-select').value = firstTask.chapters;
                        firstRow.querySelector('.content-input').value = firstTask.content || '';
                        firstRow.querySelector('.start-time').value = firstTask.startTime;
                        firstRow.querySelector('.duration').value = convertTimeToHours(firstTask.durationTime);
                    }, 100);
                    
                    // 添加其他行
                    for (let i = 1; i < plan.StudyTasks.length; i++) {
                        const task = plan.StudyTasks[i];
                        addTaskRow(task);
                    }
                }
                
                // 切换到输入表单视图
                plansList.style.display = 'none';
                inputForm.style.display = 'block';
                ganttChart.style.display = 'none';
            } else {
                alert('找不到指定的学习计划');
            }
        };
        
        // 删除学习计划
        window.deletePlan = function(planId) {
            if (confirm('确定要删除这个学习计划吗？此操作不可撤销。')) {
                // 从本地存储获取计划
                const plansData = getFromLocalStorage('plans') || [];
                
                // 过滤掉要删除的计划
                const updatedPlans = plansData.filter(plan => plan.id !== planId);
                
                // 保存回本地存储
                saveToLocalStorage('plans', updatedPlans);
                
                alert('学习计划已删除');
                loadPlans();
            }
        };
        
        // 删除行
        window.deleteRow = function(button) {
            const row = button.closest('tr');
            row.remove();
        };
        
        // 隐藏任何可能存在的服务器启动消息
        function hideServerMessages() {
            // 查找并隐藏包含"正在启动服务器"或其他服务器相关消息的元素
            document.querySelectorAll('*').forEach(el => {
                if (el.innerText && 
                   (el.innerText.includes('正在启动服务器') || 
                    el.innerText.includes('服务器') || 
                    el.innerText.includes('server'))) {
                    el.style.display = 'none';
                }
            });
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM加载完成，开始初始化应用...");
            
            // 立即隐藏服务器消息
            hideServerMessages();
            
            // 初始化DOM元素引用
            plansTab = document.getElementById('plans-tab');
            inputTab = document.getElementById('input-tab');
            chartTab = document.getElementById('chart-tab');
            plansList = document.getElementById('plans-list');
            inputForm = document.getElementById('input-form');
            ganttChart = document.getElementById('gantt-chart');
            newPlanBtn = document.getElementById('new-plan-btn');
            refreshPlansBtn = document.getElementById('refresh-plans-btn');
            addTaskBtn = document.getElementById('add-task');
            savePlanBtn = document.getElementById('save-plan');
            exportCsvBtn = document.getElementById('export-csv');
            backToPlansBtn = document.getElementById('back-to-plans');
            dateInput = document.getElementById('date');
            planNameInput = document.getElementById('plan-name');
            
            // 确保所有元素都存在
            if (!plansTab || !inputTab || !chartTab || !plansList || !inputForm || !ganttChart ||
                !newPlanBtn || !refreshPlansBtn || !addTaskBtn || !savePlanBtn || !exportCsvBtn || 
                !backToPlansBtn || !dateInput || !planNameInput) {
                console.error("部分DOM元素未找到，可能会导致功能异常");
            } else {
                console.log("所有DOM元素已成功获取");
            }
            
            // 设置事件监听器
            setupEventListeners();
            
            // 加载数据
            loadSubjects();
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            loadPlans();
            
            // 定期检查并隐藏可能新出现的服务器消息
            setInterval(hideServerMessages, 1000);
            
            // 强制显示计划列表（确保初始视图正确）
            plansList.style.display = 'block';
            inputForm.style.display = 'none';
            ganttChart.style.display = 'none';
            
            console.log("应用初始化完成");
            
            // 运行按钮诊断
            setTimeout(function() {
                console.log("开始运行按钮诊断...");
                
                // 测试各个关键按钮是否正确绑定了事件处理器
                const buttonsToCheck = [
                    { name: 'plans-tab', element: plansTab },
                    { name: 'input-tab', element: inputTab },
                    { name: 'chart-tab', element: chartTab },
                    { name: 'new-plan-btn', element: newPlanBtn },
                    { name: 'refresh-plans-btn', element: refreshPlansBtn },
                    { name: 'add-task', element: addTaskBtn },
                    { name: 'save-plan', element: savePlanBtn },
                    { name: 'export-csv', element: exportCsvBtn },
                    { name: 'back-to-plans', element: backToPlansBtn }
                ];
                
                buttonsToCheck.forEach(button => {
                    if (!button.element) {
                        console.error(`按钮 ${button.name} 未找到`);
                    } else {
                        // 注意：getEventListeners只在Chrome的开发者控制台中可用，不能在JavaScript代码中使用
                        const hasClickHandler = button.element.onclick !== null || 
                                               button.element.getAttribute('onclick') !== null;
                        
                        console.log(`按钮 ${button.name} 状态: ${button.element.tagName}, 事件处理器: ${hasClickHandler ? '已绑定或有onclick属性' : '可能未正确绑定'}`);
                        
                        // 为按钮添加高亮效果，便于调试
                        button.element.style.outline = '2px solid blue';
                        setTimeout(() => {
                            button.element.style.outline = '';
                        }, 1000);
                    }
                });
                
                // 检查全局函数是否正确注册
                const globalsToCheck = ['viewPlan', 'editPlan', 'deletePlan', 'deleteRow'];
                globalsToCheck.forEach(funcName => {
                    console.log(`全局函数 ${funcName} 是否已注册: ${typeof window[funcName] === 'function' ? '是' : '否'}`);
                });
                
                // 检查计划列表中的按钮
                const planButtons = document.querySelectorAll('#plans-table-body button');
                console.log(`计划列表中的按钮数量: ${planButtons.length}`);
                if (planButtons.length > 0) {
                    console.log('计划列表中的第一个按钮:', planButtons[0].outerHTML);
                    console.log('点击事件是否绑定:', planButtons[0].onclick ? '是' : '否');
                }
                
                console.log("按钮诊断完成");
            }, 1000);
        });
        
        // 本地存储函数
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }
        
        function getFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error reading from localStorage:', error);
                return null;
            }
        }
        
        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // 事件监听器设置
        function setupEventListeners() {
            console.log("开始设置事件监听器...");
            
            // 学科编辑模态框相关事件
            const editSubjectsBtn = document.getElementById('edit-subjects-btn');
            const subjectsModal = document.getElementById('subjects-modal');
            const closeModal = document.querySelector('.close-modal');
            const saveSubjectsBtn = document.getElementById('save-subjects-btn');
            const cancelSubjectsBtn = document.getElementById('cancel-subjects-btn');
            const subjectsJsonEditor = document.getElementById('subjects-json-editor');
            const jsonError = document.getElementById('json-error');
            
            console.log("模态框元素获取状态:", {
                editSubjectsBtn: !!editSubjectsBtn,
                subjectsModal: !!subjectsModal,
                closeModal: !!closeModal,
                saveSubjectsBtn: !!saveSubjectsBtn,
                cancelSubjectsBtn: !!cancelSubjectsBtn
            });
            
            // 打开学科编辑模态框
            if (editSubjectsBtn) {
                editSubjectsBtn.addEventListener('click', function() {
                    console.log("编辑学科按钮被点击");
                    // 从本地存储获取学科数据
                    const subjectsData = getFromLocalStorage('subjects');
                    const subjectsJson = getFromLocalStorage('subjectsJson');
                    
                    if (subjectsData) {
                        // 填充编辑器
                        if (subjectsJson) {
                            subjectsJsonEditor.value = JSON.stringify(subjectsJson, null, 2);
                        } else {
                            // 转换为包含难度选项的JSON格式
                            const formattedData = {
                                subjects: subjectsData.map(subject => {
                                    const chapters = subject.Chapters.map(chapter => chapter.name);
                                    const difficulties = {};
                                    const difficultyOptions = ["简单", "中等", "困难"];
                                    
                                    // 为每个章节设置默认难度
                                    chapters.forEach(chapter => {
                                        difficulties[chapter] = "中等";
                                    });
                                    
                                    return {
                                        name: subject.name,
                                        chapters: chapters,
                                        difficulties: difficulties,
                                        difficultyOptions: difficultyOptions
                                    };
                                })
                            };
                            
                            subjectsJsonEditor.value = JSON.stringify(formattedData, null, 2);
                        }
                        
                        jsonError.textContent = '';
                        
                        // 显示模态框
                        subjectsModal.style.display = 'flex';
                    } else {
                        // 如果没有学科数据，创建一个默认的
                        const defaultData = {
                            subjects: [
                                {
                                    name: "数学",
                                    chapters: ["Set", "Function", "Quadratics", "Surd Indices", "Geometry", "Solid Geometry", "Graphs", "Probablility", "Trigonometry", "Sequence", "Vector and matrix", "Transformation"],
                                    difficulties: {},
                                    difficultyOptions: ["简单", "中等", "困难"]
                                }
                            ]
                        };
                        
                        // 为每个章节设置默认难度
                        defaultData.subjects.forEach(subject => {
                            subject.chapters.forEach(chapter => {
                                subject.difficulties[chapter] = "中等";
                            });
                        });
                        
                        subjectsJsonEditor.value = JSON.stringify(defaultData, null, 2);
                        jsonError.textContent = '';
                        
                        // 显示模态框
                        subjectsModal.style.display = 'flex';
                    }
                });
            }
            
            // 关闭模态框
            if (closeModal) {
                closeModal.addEventListener('click', function() {
                    subjectsModal.style.display = 'none';
                });
            }
            
            // 取消编辑
            if (cancelSubjectsBtn) {
                cancelSubjectsBtn.addEventListener('click', function() {
                    subjectsModal.style.display = 'none';
                });
            }
            
            // 保存学科数据
            if (saveSubjectsBtn) {
                saveSubjectsBtn.addEventListener('click', function() {
                    try {
                        // 解析JSON
                        const subjectsData = JSON.parse(subjectsJsonEditor.value);
                        
                        // 验证格式
                        if (!subjectsData.subjects || !Array.isArray(subjectsData.subjects)) {
                            throw new Error('JSON格式错误：缺少subjects数组');
                        }
                        
                        for (const subject of subjectsData.subjects) {
                            if (!subject.name) {
                                throw new Error('JSON格式错误：学科缺少name属性');
                            }
                            if (!subject.chapters || !Array.isArray(subject.chapters)) {
                                throw new Error(`JSON格式错误：学科 "${subject.name}" 缺少chapters数组`);
                            }
                        }
                        
                        // 保存到本地存储
                        saveToLocalStorage('subjectsJson', subjectsData);
                        
                        // 转换为API格式并保存
                        const apiFormat = subjectsData.subjects.map(subject => {
                            return {
                                id: generateId(),
                                name: subject.name,
                                Chapters: subject.chapters.map(chapter => {
                                    return {
                                        id: generateId(),
                                        name: chapter
                                    };
                                })
                            };
                        });
                        
                        saveToLocalStorage('subjects', apiFormat);
                        
                        // 关闭模态框
                        subjectsModal.style.display = 'none';
                        
                        // 重新加载学科数据
                        loadSubjects();
                        
                        alert('学科和章节数据已保存');
                    } catch (error) {
                        jsonError.textContent = error.message;
                    }
                });
            }
            
            // 点击模态框外部关闭
            if (window) {
                window.addEventListener('click', function(event) {
                    if (event.target === subjectsModal) {
                        subjectsModal.style.display = 'none';
                    }
                });
            }
            
            plansTab.addEventListener('click', function() {
                console.log("计划列表选项卡被点击");
                plansList.style.display = 'block';
                inputForm.style.display = 'none';
                ganttChart.style.display = 'none';
                loadPlans();
            });
            
            inputTab.addEventListener('click', function() {
                console.log("输入计划选项卡被点击");
                plansList.style.display = 'none';
                inputForm.style.display = 'block';
                ganttChart.style.display = 'none';
            });
            
            chartTab.addEventListener('click', function() {
                console.log("甘特图选项卡被点击");
                if (!currentPlan) {
                    alert('请先选择或创建一个学习计划');
                    return;
                }
                plansList.style.display = 'none';
                inputForm.style.display = 'none';
                ganttChart.style.display = 'block';
                renderGanttChart();
            });
            
            newPlanBtn.addEventListener('click', function() {
                console.log("创建新计划按钮被点击");
                currentPlanId = null;
                currentPlan = null;
                planNameInput.value = '';
                clearTaskList();
                plansList.style.display = 'none';
                inputForm.style.display = 'block';
                ganttChart.style.display = 'none';
            });
            
            refreshPlansBtn.addEventListener('click', function() {
                console.log("刷新列表按钮被点击");
                loadPlans();
            });
            
            addTaskBtn.addEventListener('click', function() {
                console.log("添加任务按钮被点击");
                addNewTask();
            });
            
            savePlanBtn.addEventListener('click', function() {
                console.log("保存计划按钮被点击");
                saveStudyPlan();
            });
            
            exportCsvBtn.addEventListener('click', function() {
                console.log("导出CSV按钮被点击");
                exportToCsv();
            });
            
            backToPlansBtn.addEventListener('click', function() {
                console.log("返回计划列表按钮被点击");
                plansList.style.display = 'block';
                inputForm.style.display = 'none';
                ganttChart.style.display = 'none';
                loadPlans();
            });
            
            // 为日期输入添加事件监听，当日期变更时更新任务列表
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    const selectedDate = this.value;
                    if (selectedDate) {
                        // 从本地存储获取计划
                        const allPlans = getFromLocalStorage('plans') || [];
                        
                        // 查找是否有该日期的计划
                        const plansForDate = allPlans.filter(plan => plan.planDate === selectedDate);
                        
                        // 如果有该日期的计划，加载第一个
                        if (plansForDate && plansForDate.length > 0) {
                            editPlan(plansForDate[0].id);
                        } else {
                            // 如果没有该日期的计划，清空任务列表
                            currentPlanId = null;
                            currentPlan = null;
                            clearTaskList();
                        }
                    }
                });
            }
            
            // 为第一行的学科选择器添加事件监听
            if (document.querySelector('.subject-select')) {
                document.querySelector('.subject-select').addEventListener('change', function() {
                    populateChapters(this, this.value);
                });
            }

            console.log("事件监听器设置完成");
            
            // 为所有页面按钮添加调试处理
            const allButtons = document.querySelectorAll('button');
            console.log(`页面上共有 ${allButtons.length} 个按钮`);
            
            // 手动检查全局函数是否正确绑定
            try {
                if (typeof window.viewPlan === 'function') {
                    console.log("viewPlan 函数已正确绑定到全局作用域");
                } else {
                    console.error("viewPlan 函数未绑定到全局作用域");
                }
                
                if (typeof window.editPlan === 'function') {
                    console.log("editPlan 函数已正确绑定到全局作用域");
                } else {
                    console.error("editPlan 函数未绑定到全局作用域");
                }
                
                if (typeof window.deletePlan === 'function') {
                    console.log("deletePlan 函数已正确绑定到全局作用域");
                } else {
                    console.error("deletePlan 函数未绑定到全局作用域");
                }
                
                if (typeof window.deleteRow === 'function') {
                    console.log("deleteRow 函数已正确绑定到全局作用域");
                } else {
                    console.error("deleteRow 函数未绑定到全局作用域");
                }
            } catch (e) {
                console.error("检查全局函数时出错:", e);
            }
        }
        
        // 加载学科和章节数据
        function loadSubjects() {
            // 从本地存储获取学科数据
            const subjectsData = getFromLocalStorage('subjects');
            
            if (subjectsData) {
                // 将数据转换为我们需要的格式
                subjects = {};
                subjectsData.forEach(subject => {
                    subjects[subject.name] = subject.Chapters.map(chapter => chapter.name);
                });
                
                // 填充学科下拉框
                populateSubjectDropdowns();
            } else {
                // 如果没有学科数据，创建一个默认的
                subjects = {
                    "数学": ["Set", "Function", "Quadratics", "Surd Indices", "Geometry", "Solid Geometry", "Graphs", "Probablility", "Trigonometry", "Sequence", "Vector and matrix", "Transformation"]
                };
                
                // 填充学科下拉框
                populateSubjectDropdowns();
                
                // 保存到本地存储
                const apiFormat = Object.keys(subjects).map(subjectName => {
                    return {
                        id: generateId(),
                        name: subjectName,
                        Chapters: subjects[subjectName].map(chapter => {
                            return {
                                id: generateId(),
                                name: chapter
                            };
                        })
                    };
                });
                
                saveToLocalStorage('subjects', apiFormat);
                
                // 创建默认的subjects.json格式
                const defaultJson = {
                    subjects: Object.keys(subjects).map(subjectName => {
                        const chapters = subjects[subjectName];
                        const difficulties = {};
                        const difficultyOptions = ["简单", "中等", "困难"];
                        
                        // 为每个章节设置默认难度
                        chapters.forEach(chapter => {
                            difficulties[chapter] = "中等";
                        });
                        
                        return {
                            name: subjectName,
                            chapters: chapters,
                            difficulties: difficulties,
                            difficultyOptions: difficultyOptions
                        };
                    })
                };
                
                saveToLocalStorage('subjectsJson', defaultJson);
            }
        }
        
        // 填充所有学科下拉框
        function populateSubjectDropdowns() {
            const subjectSelects = document.querySelectorAll('.subject-select');
            
            subjectSelects.forEach(select => {
                // 清空现有选项
                select.innerHTML = '<option value="">-- 选择学科 --</option>';
                
                // 添加学科选项
                for (const subject in subjects) {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    select.appendChild(option);
                }
            });
        }
        
        // 填充章节下拉框
        function populateChapters(selectElement, subject) {
            const row = selectElement.closest('tr');
            const chapterSelect = row.querySelector('.chapter-select');
            
            // 清空现有选项
            chapterSelect.innerHTML = '<option value="">-- 选择章节 --</option>';
            
            if (subject && subjects[subject]) {
                subjects[subject].forEach(function(chapter) {
                    const option = document.createElement('option');
                    option.value = chapter;
                    option.textContent = chapter;
                    chapterSelect.appendChild(option);
                });
            }
        }
        
        // 加载学习计划列表
        function loadPlans() {
            // 从本地存储获取计划
            const plansData = getFromLocalStorage('plans') || [];
            plans = plansData;
            
            const plansTableBody = document.getElementById('plans-table-body');
            plansTableBody.innerHTML = '';
            
            if (plans.length === 0) {
                plansTableBody.innerHTML = '<tr><td colspan="4">暂无学习计划</td></tr>';
                return;
            }
            
            plans.forEach(plan => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${plan.name}</td>
                    <td>${formatDate(plan.planDate)}</td>
                    <td>${plan.StudyTasks ? plan.StudyTasks.length : 0}</td>
                    <td>
                        <button class="btn" onclick="viewPlan('${plan.id}')">查看</button>
                        <button class="btn" onclick="editPlan('${plan.id}')">编辑</button>
                        <button class="btn" onclick="deletePlan('${plan.id}')">删除</button>
                    </td>
                `;
                
                plansTableBody.appendChild(row);
            });
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        // 清空任务列表，只保留第一行
        function clearTaskList() {
            const taskList = document.getElementById('task-list');
            const firstRow = taskList.firstElementChild;
            taskList.innerHTML = '';
            taskList.appendChild(firstRow);
            
            // 重置第一行的输入
            firstRow.querySelector('.subject-select').value = '';
            firstRow.querySelector('.chapter-select').innerHTML = '<option value="">-- 选择章节 --</option>';
            firstRow.querySelector('.content-input').value = '';
            firstRow.querySelector('.start-time').value = '';
            firstRow.querySelector('.duration').value = '1';
        }
        
        // 添加带有预填数据的任务行
        function addTaskRow(task) {
            const taskList = document.getElementById('task-list');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <select class="subject-select">
                        <option value="">-- 选择学科 --</option>
                    </select>
                </td>
                <td>
                    <select class="chapter-select">
                        <option value="">-- 选择章节 --</option>
                    </select>
                </td>
                <td>
                    <textarea class="content-input" rows="2" cols="20"></textarea>
                </td>
                <td>
                    <input type="time" class="start-time">
                </td>
                <td>
                    <input type="number" class="duration" min="0.5" step="0.5" value="1">
                </td>
                <td>
                    <button class="btn btn-delete" onclick="deleteRow(this)">删除</button>
                </td>
            `;
            
            taskList.appendChild(newRow);
            
            // 填充学科下拉框
            const subjectSelect = newRow.querySelector('.subject-select');
            for (const subject in subjects) {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            }
            
            // 添加学科变化事件监听器
            subjectSelect.addEventListener('change', function() {
                populateChapters(this, this.value);
            });
            
            // 如果提供了任务数据，则填充
            if (task) {
                subjectSelect.value = task.subject;
                
                // 根据学科填充章节选项
                populateChapters(subjectSelect, task.subject);
                
                // 设置章节值
                setTimeout(() => {
                    newRow.querySelector('.chapter-select').value = task.chapters;
                    newRow.querySelector('.content-input').value = task.content || '';
                    newRow.querySelector('.start-time').value = task.startTime;
                    newRow.querySelector('.duration').value = convertTimeToHours(task.durationTime);
                }, 100);
            }
        }
        
        // 添加新任务行
        function addNewTask() {
            addTaskRow();
        }
        
        // 将时间格式转换为小时数
        function convertTimeToHours(timeString) {
            if (!timeString) return 1;
            
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours + (minutes / 60);
        }
        
        // 将小时数转换为时间格式
        function convertHoursToTime(hours) {
            const wholeHours = Math.floor(hours);
            const minutes = Math.round((hours - wholeHours) * 60);
            
            return `${wholeHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        // 保存学习计划
        function saveStudyPlan() {
            const planName = planNameInput.value;
            const date = dateInput.value;
            
            if (!planName) {
                alert('请输入计划名称！');
                return;
            }
            
            if (!date) {
                alert('请选择日期！');
                return;
            }
            
            const rows = document.querySelectorAll('#task-list tr');
            const tasks = [];
            
            rows.forEach(function(row) {
                const subject = row.querySelector('.subject-select').value;
                const chapter = row.querySelector('.chapter-select').value;
                const content = row.querySelector('.content-input').value;
                const startTime = row.querySelector('.start-time').value;
                const duration = row.querySelector('.duration').value;
                
                if (subject && chapter && startTime && duration) {
                    tasks.push({
                        id: generateId(),
                        subject: subject,
                        chapters: chapter,
                        content: content,
                        startTime: startTime,
                        durationTime: convertHoursToTime(parseFloat(duration))
                    });
                }
            });
            
            if (tasks.length === 0) {
                alert('请至少添加一项有效的学习计划！');
                return;
            }
            
            // 从本地存储获取现有计划
            const plansData = getFromLocalStorage('plans') || [];
            
            if (currentPlanId) {
                // 更新现有计划
                const updatedPlans = plansData.map(plan => {
                    if (plan.id === currentPlanId) {
                        return {
                            ...plan,
                            name: planName,
                            planDate: date,
                            StudyTasks: tasks
                        };
                    }
                    return plan;
                });
                
                saveToLocalStorage('plans', updatedPlans);
                currentPlan = updatedPlans.find(plan => plan.id === currentPlanId);
            } else {
                // 创建新计划
                const newPlan = {
                    id: generateId(),
                    name: planName,
                    planDate: date,
                    StudyTasks: tasks
                };
                
                plansData.push(newPlan);
                saveToLocalStorage('plans', plansData);
                currentPlanId = newPlan.id;
                currentPlan = newPlan;
            }
            
            alert('学习计划已保存！');
            
            // 切换到甘特图视图
            plansList.style.display = 'none';
            inputForm.style.display = 'none';
            ganttChart.style.display = 'block';
            
            // 显示计划名称
            document.getElementById('current-plan-name').textContent = currentPlan.name;
            
            // 渲染甘特图
            renderGanttChart();
        }
        
        // 渲染甘特图
        function renderGanttChart() {
            if (!currentPlan || !currentPlan.StudyTasks || currentPlan.StudyTasks.length === 0) {
                document.getElementById('gantt-view').innerHTML = '<p>暂无学习计划数据</p>';
                return;
            }
            
            // 获取所有计划数据
            const allPlans = getFromLocalStorage('plans') || [];
            
            // 尝试加载subjects.json以获取难度信息
            const subjectsJson = getFromLocalStorage('subjectsJson');
            
            // 提取所有唯一的日期
            const allDates = new Set();
            allPlans.forEach(plan => {
                allDates.add(plan.planDate);
            });
            
            // 将日期转换为数组并排序
            const sortedDates = Array.from(allDates).sort();
            
            // 获取所有学科和章节
            const subjectChapters = {};
            
            // 收集所有学科和章节
            for (const subject in subjects) {
                if (!subjectChapters[subject]) {
                    subjectChapters[subject] = [];
                }
                
                if (subjects[subject]) {
                    subjects[subject].forEach(chapter => {
                        subjectChapters[subject].push(chapter);
                    });
                }
            }
            
            // 计算每个章节的总持续时间
            const chapterDurations = {};
            allPlans.forEach(plan => {
                if (plan.StudyTasks) {
                    plan.StudyTasks.forEach(task => {
                        const key = `${task.subject}|${task.chapters}`;
                        if (!chapterDurations[key]) {
                            chapterDurations[key] = 0;
                        }
                        chapterDurations[key] += convertTimeToHours(task.durationTime);
                    });
                }
            });
            
            // 获取第一个日期的年份和月份作为表头
            let yearMonth = '';
            if (sortedDates.length > 0) {
                const firstDate = new Date(sortedDates[0] + 'T00:00:00');
                const year = firstDate.getFullYear();
                const month = firstDate.getMonth() + 1;
                yearMonth = `${year}年${month}月`;
            } else {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;
                yearMonth = `${year}年${month}月`;
            }
            
            // 创建甘特图表格
            let tableHTML = `<table class="gantt-table" style="border-collapse: collapse; width: 100%;">
                <thead>
                    <tr>
                        <th style="background-color: #4285f4; color: white; text-align: center; vertical-align: middle; border: 1px solid #ddd;" rowspan="2">学习科目</th>
                        <th style="background-color: #4285f4; color: white; text-align: center; vertical-align: middle; border: 1px solid #ddd;" rowspan="2">考点</th>
                        <th style="background-color: #4285f4; color: white; text-align: center; vertical-align: middle; border: 1px solid #ddd;" rowspan="2">难度</th>
                        <th style="background-color: #4285f4; color: white; text-align: center; vertical-align: middle; border: 1px solid #ddd;" rowspan="2">持续时间</th>
                        <th style="background-color: #4285f4; color: white; text-align: center; border: 1px solid #ddd;" colspan="${sortedDates.length}">${yearMonth}</th>
                    </tr>
                    <tr>`;
            
            // 添加日期列
            sortedDates.forEach(date => {
                const dateObj = new Date(date + 'T00:00:00');
                const day = dateObj.getDate();
                const month = dateObj.getMonth() + 1;
                tableHTML += `<th style="background-color: #4285f4; color: white; text-align: center; border: 1px solid #ddd; min-width: 40px;">${month}月${day}日</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            // 按学科和章节分组填充行数据
            let currentSubject = null;
            let rowspanCount = 0;
            
            // 遍历所有学科
            for (const subject in subjectChapters) {
                const chapters = subjectChapters[subject];
                rowspanCount = chapters.length;
                
                // 查找学科在subjects.json中的索引
                const subjectIndex = subjectsJson && subjectsJson.subjects ? subjectsJson.subjects.findIndex(s => s.name === subject) : -1;
                const difficultyOptions = subjectIndex >= 0 && subjectsJson.subjects[subjectIndex].difficultyOptions ? subjectsJson.subjects[subjectIndex].difficultyOptions : ["简单", "中等", "困难"];
                
                // 遍历该学科的所有章节
                chapters.forEach((chapter, index) => {
                    tableHTML += `<tr>`;
                    
                    // 只在第一行显示学科名称，并设置rowspan
                    if (index === 0) {
                        tableHTML += `<td style="background-color: #4285f4; color: white; text-align: center; vertical-align: middle; border: 1px solid #ddd;" rowspan="${rowspanCount}">${subject}</td>`;
                    }
                    
                    tableHTML += `<td style="border: 1px solid #ddd; text-align: center;">${chapter}</td>`;
                    
                    // 难度下拉框
                    let currentDifficulty = "中等";
                    if (subjectIndex >= 0 && subjectsJson.subjects[subjectIndex].difficulties && subjectsJson.subjects[subjectIndex].difficulties[chapter]) {
                        currentDifficulty = subjectsJson.subjects[subjectIndex].difficulties[chapter];
                    }
                    
                    tableHTML += `<td style="border: 1px solid #ddd; text-align: center;">
                        <select class="difficulty-select" data-subject="${subject}" data-chapter="${chapter}">`;
                    
                    difficultyOptions.forEach(option => {
                        const selected = option === currentDifficulty ? 'selected' : '';
                        tableHTML += `<option value="${option}" ${selected}>${option}</option>`;
                    });
                    
                    tableHTML += `</select></td>`;
                    
                    // 持续时间列 - 显示该章节的总时长
                    const durationKey = `${subject}|${chapter}`;
                    const totalDuration = chapterDurations[durationKey] || 0;
                    tableHTML += `<td style="border: 1px solid #ddd; text-align: center;">${totalDuration.toFixed(1)}</td>`;
                    
                    // 为每个日期创建单元格
                    sortedDates.forEach(date => {
                        // 查找该日期、学科和章节的任务
                        const matchingTasks = allPlans
                            .filter(plan => plan.planDate === date)
                            .flatMap(plan => plan.StudyTasks || [])
                            .filter(task => task && task.subject === subject && task.chapters === chapter);
                        
                        if (matchingTasks.length > 0) {
                            // 根据学科和任务内容决定颜色
                            const task = matchingTasks[0];
                            let backgroundColor = '#FFFFFF'; // 默认白色
                            
                            // 根据考点（章节）决定颜色
                            const chapterColors = {
                                'Set': '#FFFF00', // 黄色
                                'Function': '#4CAF50', // 绿色
                                'Quadratics': '#2196F3', // 蓝色
                                'Surd Indices': '#FFFF00',
                                'Geometry': '#4CAF50',
                                'Solid Geometry': '#2196F3',
                                'Graphs': '#FFFF00',
                                'Probablility': '#4CAF50',
                                'Trigonometry': '#2196F3',
                                'Sequence': '#FFFF00',
                                'Vector and matrix': '#4CAF50',
                                'Transformation': '#2196F3'
                            };
                            
                            // 如果章节在预定义的颜色映射中，使用对应的颜色
                            if (chapterColors[chapter]) {
                                backgroundColor = chapterColors[chapter];
                            } else {
                                // 如果没有预定义颜色，根据章节名称的长度决定颜色
                                const chapterLength = chapter.length;
                                if (chapterLength % 3 === 0) {
                                    backgroundColor = '#FFFF00'; // 黄色
                                } else if (chapterLength % 3 === 1) {
                                    backgroundColor = '#4CAF50'; // 绿色
                                } else {
                                    backgroundColor = '#2196F3'; // 蓝色
                                }
                            }
                            
                            tableHTML += `<td style="border: 1px solid #ddd; background-color: ${backgroundColor};"></td>`;
                        } else {
                            tableHTML += `<td style="border: 1px solid #ddd;"></td>`;
                        }
                    });
                    
                    tableHTML += `</tr>`;
                });
            }
            
            tableHTML += `</tbody></table>`;
            
            document.getElementById('gantt-view').innerHTML = tableHTML;
            
            // 为难度下拉框添加事件监听器
            document.querySelectorAll('.difficulty-select').forEach(select => {
                select.addEventListener('change', function() {
                    const subject = this.getAttribute('data-subject');
                    const chapter = this.getAttribute('data-chapter');
                    const difficulty = this.value;
                    
                    // 更新subjects.json中的难度
                    updateDifficulty(subject, chapter, difficulty);
                });
            });
        }
        
        // 更新章节难度
        function updateDifficulty(subject, chapter, difficulty) {
            // 从本地存储获取subjects.json
            const subjectsJson = getFromLocalStorage('subjectsJson');
            
            if (subjectsJson) {
                // 查找学科
                const subjectIndex = subjectsJson.subjects.findIndex(s => s.name === subject);
                if (subjectIndex >= 0) {
                    // 确保difficulties对象存在
                    if (!subjectsJson.subjects[subjectIndex].difficulties) {
                        subjectsJson.subjects[subjectIndex].difficulties = {};
                    }
                    
                    // 更新难度
                    subjectsJson.subjects[subjectIndex].difficulties[chapter] = difficulty;
                    
                    // 保存回本地存储
                    saveToLocalStorage('subjectsJson', subjectsJson);
                }
            }
        }
        
        // 导出为CSV
        function exportToCsv() {
            if (!currentPlan || !currentPlan.StudyTasks || currentPlan.StudyTasks.length === 0) {
                alert('没有数据可导出');
                return;
            }
            
            // 获取所有计划数据
            const allPlans = getFromLocalStorage('plans') || [];
            
            // 尝试加载subjects.json以获取难度信息
            const subjectsJson = getFromLocalStorage('subjectsJson');
            
            // 提取所有唯一的日期
            const allDates = new Set();
            allPlans.forEach(plan => {
                allDates.add(plan.planDate);
            });
            
            // 将日期转换为数组并排序
            const sortedDates = Array.from(allDates).sort();
            
            // 获取所有学科和章节
            const subjectChapters = {};
            
            // 收集所有学科和章节
            for (const subject in subjects) {
                if (!subjectChapters[subject]) {
                    subjectChapters[subject] = [];
                }
                
                if (subjects[subject]) {
                    subjects[subject].forEach(chapter => {
                        subjectChapters[subject].push(chapter);
                    });
                }
            }
            
            // 计算每个章节的总持续时间
            const chapterDurations = {};
            allPlans.forEach(plan => {
                if (plan.StudyTasks) {
                    plan.StudyTasks.forEach(task => {
                        const key = `${task.subject}|${task.chapters}`;
                        if (!chapterDurations[key]) {
                            chapterDurations[key] = 0;
                        }
                        chapterDurations[key] += convertTimeToHours(task.durationTime);
                    });
                }
            });
            
            // 获取第一个日期的年份和月份作为表头
            let yearMonth = '';
            if (sortedDates.length > 0) {
                const firstDate = new Date(sortedDates[0] + 'T00:00:00');
                const year = firstDate.getFullYear();
                const month = firstDate.getMonth() + 1;
                yearMonth = `${year}年${month}月`;
            } else {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;
                yearMonth = `${year}年${month}月`;
            }
            
            // 创建CSV内容
            let csvContent = '学习科目,考点,难度,持续时间,';
            
            // 添加年月行
            for (let i = 0; i < sortedDates.length; i++) {
                csvContent += yearMonth + ',';
            }
            csvContent += '\n';
            
            // 添加日期行
            csvContent += ',,,';
            sortedDates.forEach(date => {
                const dateObj = new Date(date);
                const day = dateObj.getDate();
                csvContent += `4月${day}日,`;
            });
            csvContent += '\n';
            
            // 按学科和章节分组填充行数据
            for (const subject in subjectChapters) {
                const chapters = subjectChapters[subject];
                
                // 查找学科在subjects.json中的索引
                const subjectIndex = subjectsJson && subjectsJson.subjects ? subjectsJson.subjects.findIndex(s => s.name === subject) : -1;
                
                // 遍历该学科的所有章节
                chapters.forEach((chapter, index) => {
                    // 获取难度
                    let difficulty = "中等";
                    if (subjectIndex >= 0 && subjectsJson.subjects[subjectIndex].difficulties && subjectsJson.subjects[subjectIndex].difficulties[chapter]) {
                        difficulty = subjectsJson.subjects[subjectIndex].difficulties[chapter];
                    }
                    
                    // 获取持续时间
                    const durationKey = `${subject}|${chapter}`;
                    const totalDuration = chapterDurations[durationKey] || 0;
                    
                    if (index === 0) {
                        // 第一行显示学科名称
                        csvContent += `${subject},${chapter},${difficulty},${totalDuration.toFixed(1)},`;
                    } else {
                        // 后续行不显示学科名称
                        csvContent += `,${chapter},${difficulty},${totalDuration.toFixed(1)},`;
                    }
                    
                    // 为每个日期创建单元格
                    sortedDates.forEach(date => {
                        // 查找该日期、学科和章节的任务
                        const matchingTasks = allPlans
                            .filter(plan => plan.planDate === date)
                            .flatMap(plan => plan.StudyTasks || [])
                            .filter(task => task && task.subject === subject && task.chapters === chapter);
                        
                        if (matchingTasks.length > 0) {
                            // 根据学科和任务内容决定颜色代码
                            const task = matchingTasks[0];
                            let colorCode = 'Y'; // 默认黄色
                            
                            // 根据考点（章节）决定颜色代码
                            const chapterColorCodes = {
                                'Set': 'Y',
                                'Function': 'G',
                                'Quadratics': 'B',
                                'Surd Indices': 'Y',
                                'Geometry': 'G',
                                'Solid Geometry': 'B',
                                'Graphs': 'Y',
                                'Probablility': 'G',
                                'Trigonometry': 'B',
                                'Sequence': 'Y',
                                'Vector and matrix': 'G',
                                'Transformation': 'B'
                            };
                            
                            // 如果章节在预定义的颜色映射中，使用对应的颜色代码
                            if (chapterColorCodes[chapter]) {
                                colorCode = chapterColorCodes[chapter];
                            } else {
                                // 如果没有预定义颜色，根据章节名称的长度决定颜色
                                const chapterLength = chapter.length;
                                if (chapterLength % 3 === 0) {
                                    colorCode = 'Y'; // 黄色
                                } else if (chapterLength % 3 === 1) {
                                    colorCode = 'G'; // 绿色
                                } else {
                                    colorCode = 'B'; // 蓝色
                                }
                            }
                            
                            csvContent += `${colorCode},`;
                        } else {
                            csvContent += ',';
                        }
                    });
                    
                    csvContent += '\n';
                });
            }
            
            // 创建下载链接
            const encodedUri = encodeURI('data:text/csv;charset=utf-8,\uFEFF' + csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `学习计划甘特图.csv`);
            document.body.appendChild(link);
            
            // 触发下载
            link.click();
            document.body.removeChild(link);
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>学习计划甘特图生成器</h1>
        
        <div class="tab-container">
            <button class="tab-button" id="plans-tab">学习计划列表</button>
            <button class="tab-button" id="input-tab">输入学习计划</button>
            <button class="tab-button" id="chart-tab">查看甘特图</button>
        </div>
        
        <div class="plans-list" id="plans-list">
            <h2 class="form-title">学习计划列表</h2>
            
            <div class="btn-group">
                <button class="btn" id="new-plan-btn">创建新计划</button>
                <button class="btn" id="refresh-plans-btn">刷新列表</button>
                <button class="btn" id="edit-subjects-btn">编辑学科和章节</button>
            </div>
            
            <!-- 学科编辑模态框 -->
            <div id="subjects-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>编辑学科和章节</h2>
                        <span class="close-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <textarea id="subjects-json-editor" rows="20" style="width: 100%; font-family: monospace;"></textarea>
                        <div class="error-message" id="json-error" style="color: red; margin-top: 10px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" id="save-subjects-btn">保存</button>
                        <button class="btn" id="cancel-subjects-btn">取消</button>
                    </div>
                </div>
            </div>
            
            <table class="plans-table">
                <thead>
                    <tr>
                        <th>计划名称</th>
                        <th>日期</th>
                        <th>任务数量</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="plans-table-body">
                    <!-- 计划列表将在这里动态生成 -->
                </tbody>
            </table>
        </div>
        
        <div class="input-form" id="input-form" style="display: none;">
            <h2 class="form-title">学习计划输入</h2>
            
            <div class="plan-name-input">
                <label for="plan-name">计划名称：</label>
                <input type="text" id="plan-name" placeholder="例如：期中考试复习计划" required>
            </div>
            
            <div class="form-row">
                <label for="date">日期：</label>
                <input type="date" id="date" required>
            </div>
            
            <table class="task-table">
                <thead>
                    <tr>
                        <th>学科</th>
                        <th>复习章节</th>
                        <th>学习内容</th>
                        <th>开始时间</th>
                        <th>时长(小时)</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="task-list">
                    <tr>
                        <td>
                            <select id="subject" class="subject-select">
                                <option value="">-- 选择学科 --</option>
                            </select>
                        </td>
                        <td>
                            <select id="chapter" class="chapter-select">
                                <option value="">-- 选择章节 --</option>
                            </select>
                        </td>
                        <td>
                            <textarea id="content" class="content-input" rows="2" cols="20"></textarea>
                        </td>
                        <td>
                            <input type="time" id="start-time" class="start-time">
                        </td>
                        <td>
                            <input type="number" id="duration" class="duration" min="0.5" step="0.5" value="1">
                        </td>
                        <td>
                            <button class="btn btn-delete" onclick="deleteRow(this)">删除</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div class="btn-group">
                <button class="btn" id="add-task">添加任务</button>
                <button class="btn" id="save-plan">保存计划</button>
            </div>
        </div>
        
        <div class="gantt-chart" id="gantt-chart" style="display: none;">
            <h2 class="form-title">学习计划甘特图</h2>
            <h3 id="current-plan-name"></h3>
            
            <div class="gantt-container">
                <div id="gantt-view"></div>
            </div>
            
            <div class="btn-group">
                <button class="btn" id="export-csv">导出为CSV</button>
                <button class="btn" id="back-to-plans">返回计划列表</button>
            </div>
        </div>
    </div>
</body>
</html>
